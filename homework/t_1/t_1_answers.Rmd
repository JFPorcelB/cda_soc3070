---
title: "SOC3070 Análisis de Datos Categóricos"
author: "Trabajo 1"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r, echo=FALSE,message=FALSE, warnings=FALSE}
# Escribir install.packages("tinytex") en la consola para instalar "tinytex"
# Escribir install.packages("tidyverse") en la consola para instalar "tinytex"
# Escribir install.packages("modelr") en la consola para instalar "tinytex"
library("tinytex")
library("tidyverse")
library("modelr")
library("httr")
library("ggsci")
```

## Información

- Ponderación: 20% de la nota final del curso.

- Bonus: Responder la pregunta _bonus_ NO es un requisito necesario para obtener puntaje completo. Responder incorrectamente la pregunta _bonus_ no afectará negativamente la nota obtenida, pero responderla correctamente mejorará la nota obtenida en un máximo de 0.5 puntos (o en la cantidad necesaria para obtener nota máxima si la nota original fuera superior a 6.5)


## Introducción

En esta tarea usarán el modelo lineal de probabilidad (LPM) y regresión logística para analizar una submuestra de la encuenta CASEN 2017. Específicamente, deberán trabajar con un modelo de regresión que busca modelar la probabilidad de estar afiliado a una ISAPE (en vez de Fonasa u otros) como función del género, estado ocupacional e ingreso total del hogar (per capita). 

## Datos

Usar el siguiente código para cargar los datos desde el repositorio del curso:

````{r, message=FALSE, warnings=FALSE}

sample_casen2017 <- read_csv("https://raw.githubusercontent.com/mebucca/cda_soc3070/master/homework/t_1/casen2017.csv") %>% filter(ingresos<=100)
sample_casen2017 %>% glimpse()

````


## Descripción de variables relevantes

- `isapre` indica si el entrevistado está afiliado a una ISAPE (`isapre`=1) en vez de Fonasa u otros (`isapre`=0).

- `mujer` indica si el entrevistado es mujer (`mujer`=1) u hombre (`mujer`=0).

- `ingresos` ingreso total del hogar (per capita) medido en 100 miles de pesos (ej., `ingresos`=2 corresponde a docientos mil pesos).

- `ocupado` indica si el entrevistado se encuentra ocupado (`ocupado`=1) o desempleado/inactivo (`ocupado`=0).


## Ejercicios

1. Usa un LPM para estimar la probabilidad de estar afiliado a una ISAPE como función del género, estado ocupacional e ingreso total del hogar. Considera sólo un efecto aditivo para cada predictor (sin interacciones ni polinomios). Escribe la ecuación de regresión y presenta un `summary()` de los resultados.

La ecuación de regresión es: 

$$\mathbb{P}(\text{isapre | mujer, ingresos, ocupado}) =  \beta_{0} + \beta_{mujer}\text{mujer} + \beta_{ingresos}\text{ingresos} + \beta_{ocupado}\text{ocupado}$$

Implementación en `R`: 

````{r}
lpm_1 <- lm(isapre ~ factor(mujer) + ingresos + factor(ocupado) , data=sample_casen2017)
summary(lpm_1)
````

1.1 Interpreta el coeficiente asociado a `ocupado`.

El coeficiente asociado a `ocupado` indica que, manteniendo los otros factores constantes, la probabilidad esperada de que una persona ocupada se encuentre afiliada a una ISAPRE es `r round(summary(lpm_1)$coefficients[4,1],2)*100` punto porcentuales mayor que la de una persona desempleada/inactiva.


1.2 De acuerdo al modelo estimado en 1.,  ¿cuál es el efecto marginal de los ingresos sobre la probabilidad esperada estar afiliado a una ISAPRE?

El coeficiente asociado a `ingresos` indica que, manteniendo los otros factores constantes, un aumento en 100 mil pesos de ingresos se traduce en un aumento de `r round(summary(lpm_1)$coefficients[3,1],2)*100` puntos porcentuales en la probabilidad esperada estar afiliado a una ISAPRE.


1.3 En base al modelo usado en 1., calcula las probabilidades esperadas de que una mujer desempleada/inactiva esté afiliada a una ISAPRE si su ingreso per capita es 100 mil y 1 millón 200 mil, respectivamente. Expresa formalmente las ecuaciones correspondiente a estas predicciones.


Formalmente:

- $\mathbb{P}(\text{isapre | mujer=1, ingresos=1, ocupado=0)} = \beta_{0} + \beta_{mujer} + \beta_{ingresos}*1  = -0.0181807 -0.0334598 + 0.0316026 = -0.0200379$

- $\mathbb{P}(\text{isapre | mujer=1, ingresos=12, ocupado=0)} = \beta_{0} + \beta_{mujer} + \beta_{ingresos}*12  = -0.0181807 -0.0334598 + 0.0316026*12 = 0.3275907$


Implementación en `R`:  
````{r}
newx <- sample_casen2017 %>% data_grid(ocupado=0, ingresos=c(1,12), mujer=1,.model=lpm_1)
newy <- newx %>% mutate(pred_prob = predict(lpm_1, newdata = newx)) 
print(newy)
````


1.4. Agrega una interacción entre `mujer` e `ingresos` al modelo estimado en 1. Escribe la ecuación de regresión y presenta un `summary()` de los resultados. Interpreta el efecto de los ingresos estimado en este modelo.

La ecuación de regresión es: 

$$\mathbb{P}(\text{isapre | mujer, ingresos, ocupado)} = y =  \beta_{0} + \beta_{mujer}\text{mujer} + \beta_{ingresos}\text{ingresos} + \beta_{ocupado}\text{ocupado} + \beta_{mujer:ingresos}\text{mujer}*\text{ingresos}$$
Implementación en `R`: 
````{r}
lpm_2 <- lm(isapre ~ factor(mujer)*ingresos + factor(ocupado) , data=sample_casen2017)
summary(lpm_2)
````

Al añadir una interacción entre `mujer` e `ingresos` permitimos que el efecto de "ingresos" dependa de si el entrevistado es mujer u hombre (y viceversa). Es decir, no hay un único efecto de los ingresos si no dos. Para los hombres desempleados/inactivos la probabilidad esperada de estar afiliado a una ISAPRE es:


- $\mathbb{P}(\text{isapre | mujer=0, ingresos, ocupado=0)} = \beta_{0} + \beta_{ingresos}\text{ingresos}$. 

Por tanto, el efecto de `ingresos` sobre la probabilidad de que un hombre desocupado esté afiliado a una ISAPRE es: 

- $\frac{\partial \mathbb{P}(\text{isapre | mujer=0, ingresos, ocupado=0})}{\partial \text{ingresos}} = \beta_{ingresos} = 0.031$


Por su parte, para las mujeres desempleadas/inactivas la probabilidad esperada de estar afiliada a una ISAPRE viene dada por:

- $\mathbb{P}(\text{isapre | mujer=1, ingresos, ocupado=0)}  = \beta_{0} + \beta_{mujer} + \beta_{ingresos}\text{ingresos} + \beta_{mujer:ingresos}\text{ingresos} = (\beta_{0} + \beta_{mujer}) + (\beta_{ingresos} + \beta_{mujer:ingresos})\text{ingresos}$ 

Por tanto, el efecto de `ingresos` sobre la probabilidad de que una mujer desocupada esté afiliada a una ISAPRE es: 

- $\frac{\partial \mathbb{P}(\text{isapre | mujer=1, ingresos, ocupado=0})}{\partial \text{ingresos}} = \beta_{ingresos} + \beta_{mujer:ingresos} = 0.033$


2. Usa una regresión logística para estimar la probabilidad de estar afiliado a una ISAPE como función del género, estado ocupacional e ingreso total del hogar. Considera sólo un efecto aditivo para cada predictor (sin interacciones ni polinomios). Escribe la ecuación de regresión y presenta un `summary()` de los resultados.

La ecuación de regresión es: 

$\ln\frac{\mathbb{P}(\text{isapre | mujer, ingresos, ocupado)}}{1-\mathbb{P}(\text{isapre | mujer, ingresos, ocupado)}} = \beta_{0} + \beta_{mujer}\text{mujer} + \beta_{ingresos}\text{ingresos} + \beta_{ocupado}\text{ocupado}$


Implementación en `R`: 
````{r}
logit_1 <- glm(isapre ~ factor(mujer) + ingresos + factor(ocupado), family = binomial(link=logit), data=sample_casen2017)
summary(logit_1)
````

2.1 Interpreta el coeficiente asociado a `ocupado`.

El coeficiente asociado a `ocupado` indica que, manteniendo los otros factores constantes, las log-odds de estar afiliado a una ISAPE de las personas ocupadas son `r round(summary(logit_1)$coefficients[4],2)` puntos mayores que las de las personas desempleadas/inactivas.


2.2 Transforma e interpreta el coeficiente de interés de 2.1. en términos de odds-ratios. Presenta el desarrollo formal.

Transformamos los coeficientes en odds ratios exponenciando los coeficientes originales:


Implementación en `R`: 
````{r}
exp(summary(logit_1)$coefficients[4,1])
````


Formalmente: Dado la ecuación de regresión logística,

$\ln\frac{\mathbb{P}(\text{isapre | mujer, ingresos, ocupado})}{1-\mathbb{P}(\text{isapre | mujer, ingresos, ocupado})} =\beta_{0} + \beta_{mujer}\text{mujer} + \beta_{ingresos}\text{ingresos} + \beta_{ocupado}\text{ocupado}$


podemos re-expresar el modelo en términos de odds de estar afiliado a una ISAPE:

$\frac{\mathbb{P}(\text{isapre | mujer, ingresos, ocupado})}{1-\mathbb{P}(\text{isapre | mujer, ingresos, ocupado})} =e^{\beta_{0}} e^{\beta_{mujer}\text{mujer}} e^{\beta_{ingresos}\text{ingresos}} e^{\beta_{ocupado}\text{ocupado}}$


Por tanto, las odds de estar afiliado a una ISAPE para una persona ocupada son:


$\text{odds}_{\text{ocupado}=1}: \frac{\mathbb{P}(\text{isapre | mujer, ingresos, ocupado=1})}{1-\mathbb{P}(\text{isapre | mujer, ingresos, ocupado=1})} =e^{\beta_{0}} e^{\beta_{mujer}\text{mujer}} e^{\beta_{ingresos}\text{ingresos}} e^{\beta_{ocupado}}$


y las odds de estar afiliado a una ISAPE para personas desempleadas/inactivas son:


$\text{odds}_{\text{ocupado}=0}: \frac{\mathbb{P}(\text{isapre | mujer, ingresos, ocupado=0})}{1-\mathbb{P}(\text{isapre | mujer, ingresos, ocupado=0})} = e^{\beta_{0}} e^{\beta_{mujer}\text{mujer}} e^{\beta_{ingresos}\text{ingresos}}$


Luego, la razón de las odds de estar afiliado a una ISAPE entre una persona ocupada y una persona desempleada/inactiva es:

$\frac{\text{odds}_{\text{ocupado}=1}}{\text{odds}_{\text{ocupado}=0}} = \frac{e^{\beta_{0}} e^{\beta_{mujer}\text{mujer}} e^{\beta_{ingresos}\text{ingresos}} e^{\beta_{ocupado}}}{e^{\beta_{0}} e^{\beta_{mujer}\text{mujer}} e^{\beta_{ingresos}\text{ingresos}}} = e^{\beta_{ocupado}}$


Es decir, las odds de estar afiliado a una ISAPE de una persona ocupada son `r round(exp(summary(logit_1)$coefficients[4,1]),2)` veces las odds de una persona desempleada/inactiva (`r round(exp(summary(logit_1)$coefficients[4,1]) - 1,2)*100`\% más altas).


2.3 De acuerdo al modelo estimado en 2, calcula las probabilidades esperadas de que una mujer desempleada/inactiva esté afiliada a una ISAPRE si su ingreso per capita es 100 mil y 1 millón 200 mil, respectivamente. Expresa formalmente las ecuaciones correspondiente a estas predicciones.. Compara este resultado con el obtenido en 1.3.


Formalmente:


- $\mathbb{P}(\text{isapre | mujer=1, ingresos=1, ocupado=0)} = \frac{1}{1 + e^{-(\beta_{0} + \beta_{mujer} + \beta_{ingresos}*1)}} = 1/(1 + \exp(-(-3.640138 + 0.270258*1 -0.408902))) = 0.02234003$


- $\mathbb{P}(\text{isapre | mujer=1, ingresos=12, ocupado=0)} = \frac{1}{1 + e^{-(\beta_{0} + \beta_{mujer} + \beta_{ingresos}*12)}}=1/(1 + \exp(-(-3.640138 + 0.270258*12 -0.408902))) = 0.3087555$ 


Implementación en `R`:  
````{r}
newx <- sample_casen2017 %>% data_grid(ocupado=0, ingresos=c(1,12), mujer=1,.model=logit_1)
newy <- newx %>% mutate(pred_prob = predict(logit_1, newdata = newx, type="response")) 
print(newy)
````

A diferencia del LPM, el sigmoide $1/(1 + e^{-x})$ garantiza que las probabilidades predichas siempre serán restringidas al rango 0-1.

2.4. De acuerdo al modelo estimado en 2., ¿cual es el efecto marginal de los ingresos sobre la probabilidad esperada de estar afiliado a una ISAPRE? Calcula esta cantidad para un una mujer desempleada/inactiva si su ingreso per capita es 100 mil y 1 millón 200 mil, respectivamente. Compara esta respuesta con la respuesta dada en 1.2.

Recordar que: $\frac{\partial p_{i} }{\partial \text{ingresos}} =  \beta_{\text{ingresos}}   \times p_{i}(1-p_{i})$


donde $p_{i} = \mathbb{P}(\text{isapre | mujer, ingresos, ocupado)} = \frac{1}{1 + e^{-(\beta_{0} + \beta_{mujer}\text{mujer} + \beta_{ingresos}\text{ingresos}+ \beta_{ocupado}\text{ocupado})}})$


De 2.3. sabemos que para una mujer desempleada/inactiva con un ingreso per capita es 100 mil, $\mathbb{P}(\text{isapre | mujer=1, ingresos=1, ocupado=0}) =  0.02234003$. Por tanto,

- $\frac{\partial p_{i} }{\partial \text{ingresos}} =  \beta_{\text{ingresos}}   \times p_{i}(1-p_{i}) =   0.270258*0.02234003*(1-0.02234003) = 0.005902692$

Es decir, manteniendo otros factores constantes, un incremento en el ingreso desde 100 a 200 mil pesos implica un aumento de 0.006 puntos porcentuales en la probabilidad de estar afiliado a una isapre.

Por su parte, de 2.3. sabemos que para una mujer desempleada/inactiva con un ingreso per capita es 1 millón 200 mil pesos, $\mathbb{P}(\text{isapre | mujer=1, ingresos=12, ocupado=0}) =  0.3087555$. Por tanto,

- $\frac{\partial p_{i} }{\partial \text{ingresos}} =  \beta_{\text{ingresos}}   \times p_{i}(1-p_{i}) =   0.270258*0.3087555*(1-0.3087555) = 0.05767996$

Es decir, manteniendo otros factores constantes, un incremento en el ingreso desde 1 millón 200 mil a 1 millón 300 mil pesos implica un aumento de 0.06 puntos porcentuales en la probabilidad de estar afiliado a una isapre.


A diferencia del LPM, en el modelo de regresión logística el efecto de los ingresos depende del valor de la misma variable y del valor de otras covariables. Esta característica regula que los efectos sean muy limitados cuando las probabilidades se acercan a cero o uno, mientras que pueden ser mayores lejos de dichos valores.

\pagebreak


## Bonus: 

El siguiente gráfico describe las probabilidad predichas por el LMP estimado en 1. y la regresión logística estimada en 2. de que una mujer desocupada se encuentre afiliada a una ISAPRE, para diferentes niveles de ingreso total.


Implementación en `R`: 
````{r}
# crea un nuevo set de datos sobre los cuales crear predicciones
newx <- sample_casen2017 %>% data_grid(ocupado=0, ingresos=seq(0,20), mujer=1, .model=lpm_1)

# crea valores predichos para el nuevo set de datos
xb_lpm = predict(lpm_1 , newdata = newx)
xb_logit = predict(logit_1, newdata = newx)
prob_lpm = xb_lpm
prob_logit = 1/(1 + exp(-xb_logit))

newy <- newx %>% mutate(prob_lpm = prob_lpm, prob_logit = prob_logit) 

# crea gráfico 
newy %>% ggplot(aes(x=ingresos, y=prob_lpm, colour="LPM")) +
  geom_line(size=1.5) +
  geom_line(aes(x=ingresos, y=prob_logit, colour="Logística"), size=1.5) +
  labs(y="P(isapre | mujer=1, ingresos, ocupado=0)", x="hand strength", colour="modelo") +
  scale_color_aaas() + theme_bw()
````


3.1 Inspecciona visualmente la figura y determina (aproximadamente) el nivel de ingreso para el cual encontramos el mayor _efecto_ de "ingresos" sobre la probabilidad de que una mujer ocupada se encuentre afiliada a una ISAPRE. 

El mayor efecto marginal de los ingresos se da cuando los ingresos son de aproximádamente 1 millón 500 mil pesos.

3.2 ¿Cuál es el mayor efecto posible de los ingresos? 

El mayor efecto de los ingresos ocurre cuando $p_{i}=0.5$, por tanto el mayor efecto marginal de los ingresos es $\frac{\partial p_{i} }{\partial \text{ingresos}} =  \beta_{\text{ingresos}}/4 =   0.270258/4= 0.0675645$

3.3 Verdadero o falso: "el efecto no lineal de `ingresos` en el modelo de regresión logística (linea azul) se debe a que la especificación del modelo permite tal no-linealidad (por ejemplo, usando un término cuadrático o cúbico)". Justifica tu respuesta. 

Falso. La especificación del modelo no considera un efecto no-lineal de los ingresos. La relación no lineal respecto de la probabilidad de estar afiliado a una isapre es inducida por el la "link function" logit. 


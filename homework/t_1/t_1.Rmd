---
title: "SOC3070 Análisis de Datos Categóricos"
author: "Trabajo 1"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r, echo=FALSE,message=FALSE, warnings=FALSE}
# Escribir install.packages("tinytex") en la consola para instalar "tinytex"
# Escribir install.packages("tidyverse") en la consola para instalar "tinytex"
# Escribir install.packages("modelr") en la consola para instalar "tinytex"
library("tinytex")
library("tidyverse")
library("modelr")
library("httr")
library("ggsci")
```

## Información

- Ponderación: 20% de la nota final del curso.

- Bonus: Responder la pregunta _bonus_ NO es un requisito necesario para obtener puntaje completo. Responder incorrectamente la pregunta _bonus_ no afectará negativamente la nota obtenida, pero responderla correctamente mejorará la nota obtenida en un máximo de 0.5 puntos (o en la cantidad necesaria para obtener nota máxima si la nota original fuera superior a 6.5)


## Introducción

En esta tarea usarán el modelo lineal de probabilidad (LPM) y regresión logística para analizar una submuestra de la encuenta CASEN 2017. Específicamente, deberán trabajar con un modelo de regresión que busca modelar la probabilidad de estar afiliado a una ISAPE (en vez de Fonasa u otros) como función del género, estado ocupacional e ingreso total del hogar (per capita). 

## Datos

Usar el siguiente código para cargar los datos desde el repositorio del curso:

````{r, message=FALSE, warnings=FALSE}

sample_casen2017 <- read_csv("https://raw.githubusercontent.com/mebucca/cda_soc3070/master/homework/t_1/casen2017.csv") %>% filter(ingresos<=100)
sample_casen2017 %>% glimpse()

````


## Descripción de variables relevantes

- `isapre` indica si el entrevistado está afiliado a una ISAPE (`isapre`=1) en vez de Fonasa u otros (`isapre`=0).

- `mujer` indica si el entrevistado es mujer (`mujer`=1) u hombre (`mujer`=0).

- `ingresos` ingreso total del hogar (per capita) medido en 100 miles de pesos (ej., `ingresos`=2 corresponde a docientos mil pesos).

- `ocupado` indica si el entrevistado se encuentra ocupado (`ocupado`=1) o desempleado/inactivo (`ocupado`=0).


## Ejercicios

1. Usa un LPM para estimar la probabilidad de estar afiliado a una ISAPE como función del género, estado ocupacional e ingreso total del hogar. Considera sólo un efecto aditivo para cada predictor (sin interacciones ni polinomios). Escribe la ecuación de regresión y presenta un `summary()` de los resultados.

1.1 Interpreta el coeficiente asociado a `ocupado`.


1.2 De acuerdo al modelo estimado en 1.,  ¿cuál es el efecto marginal de los ingresos sobre la probabilidad esperada estar afiliado a una ISAPRE?


1.3 En base al modelo usado en 1., calcula las probabilidades esperadas de que una mujer desempleada/inactiva esté afiliada a una ISAPRE si su ingreso per capita es 100 mil y 1 millón 200 mil, respectivamente. Expresa formalmente las ecuaciones correspondiente a estas predicciones.


1.4. Agrega una interacción entre `mujer` e `ingresos` al modelo estimado en 1. Escribe la ecuación de regresión y presenta un `summary()` de los resultados. Interpreta el efecto de los ingresos estimado en este modelo.


2. Usa una regresión logística para estimar la probabilidad de estar afiliado a una ISAPE como función del género, estado ocupacional e ingreso total del hogar. Considera sólo un efecto aditivo para cada predictor (sin interacciones ni polinomios). Escribe la ecuación de regresión y presenta un `summary()` de los resultados.


2.1 Interpreta el coeficiente asociado a `ocupado`.


2.2 Transforma e interpreta el coeficiente de interés de 2.1. en términos de odds-ratios. Presenta el desarrollo formal.


2.3 De acuerdo al modelo estimado en 2, calcula las probabilidades esperadas de que una mujer desempleada/inactiva esté afiliada a una ISAPRE si su ingreso per capita es 100 mil y 1 millón 200 mil, respectivamente. Expresa formalmente las ecuaciones correspondiente a estas predicciones.. Compara este resultado con el obtenido en 1.3.


2.4. De acuerdo al modelo estimado en 2., ¿cual es el efecto marginal de los ingresos sobre la probabilidad esperada de estar afiliado a una ISAPRE? Calcula esta cantidad para un una mujer desempleada/inactiva si su ingreso per capita es 100 mil y 1 millón 200 mil, respectivamente. Compara esta respuesta con la respuesta dada en 1.2.


\pagebreak


## Bonus: 

El siguiente gráfico describe las probabilidad predichas por el LMP estimado en 1. y la regresión logística estimada en 2. de que una mujer ocupada se encuentre afiliada a una ISAPRE, para diferentes niveles de ingreso total.


````{r, echo=F}

lpm_1 <- lm(isapre ~ factor(mujer) + ingresos + factor(ocupado) , data=sample_casen2017)
logit_1 <- glm(isapre ~ factor(mujer) + ingresos + factor(ocupado), family = binomial(link=logit), data=sample_casen2017)

# crea un nuevo set de datos sobre los cuales crear predicciones
newx <- sample_casen2017 %>% data_grid(ocupado=1, ingresos=seq(0,20), mujer=0, .model=lpm_1)

# crea valores predichos para el nuevo set de datos
xb_lpm = predict(lpm_1 , newdata = newx)
xb_logit = predict(logit_1, newdata = newx)
prob_lpm = xb_lpm
prob_logit = 1/(1 + exp(-xb_logit))

newy <- newx %>% mutate(prob_lpm = prob_lpm, prob_logit = prob_logit) 

# crea gráfico 
newy %>% ggplot(aes(x=ingresos, y=prob_lpm, colour="LPM")) +
  geom_line(size=1.5) +
  geom_line(aes(x=ingresos, y=prob_logit, colour="Logística"), size=1.5) +
  labs(y="P(wg | pid=0, hs, wt=1)", x="hand strength", colour="modelo") +
  scale_color_aaas() + theme_bw()
````


3.1 Inspecciona visualmente la figura y determina (aproximadamente) el nivel de ingreso para el cual encontramos el mayor _efecto_ de "ingresos" sobre la probabilidad de que una mujer ocupada se encuentre afiliada a una ISAPRE. 


3.2 ¿Cuál es el mayor efecto posible de los ingresos? 


3.3 Verdadero o falso: "el efecto no lineal de `ingresos` en el modelo de regresión logística (linea azul) se debe a que la especificación del modelo permite tal no-linealidad (por ejemplo, usando un término cuadrático o cúbico)". Justifica tu respuesta. 




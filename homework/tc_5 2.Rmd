---
title: "SOC3070 Análisis de Datos Categóricos"
author: "Tarea corta 5"
output:
  pdf_document: default
  html_document:
    df_print: paged
---


```{r, echo=FALSE, message=FALSE}
# Escribir install.packages("tinytex") en la consola para instalar "tinytex"
# Carga "tinytex" para compilar PDF
library("tinytex")
library("tidyverse")
library("vcdExtra")
library("carData") 
library("margins") 
library("modelr") 
library("msm")
data("Chile") 
datos_chile <- Chile
```

Ponderación: 6% de la nota final del curso. Entrega: Desde el momento de entrega, los estudiantes tienen 1 semana exacta de plazo para completar esta tarea.

$$\newcommand{\vect}[1]{\boldsymbol{#1}}$$



![NO](no.jpg)

## Problema: 

En esta tarea usarás los datos de una encuesta realizada por FLACSO/Chile en Abril y Mayo de 1988 sobre intención de voto en el plebiscito de 1989, junto con otras variables socio-demográficas. 

```{r}
datos_chile <- datos_chile %>% mutate(vote = case_when(vote=="Y" ~ 0, vote=="N" ~ 1)) 
datos_chile %>% glimpse()
```

En particular, trabajarás con el siguiente modelo de regresión logística que estima la probabilidad de votar NO en función de los ingresos, género (M=Hombre, F=Mujer) y el apoyo al status-quo (valores más altos indican mayor apoyo al régimen de Pinochet).

```{r}
mymodel <- glm(vote ~ income  + sex*statusquo, family=binomial, data = datos_chile )
summary(mymodel)
```

1. Calcula el efecto marginal sobre la probabilida de votar por el NO de la variable "statusquo" para hombres y mujeres (por separado), fijando ingresos y apoyo al status-quo a sus respectivos valores medianos (en la muestra completa).

Nota: recuerda que dado la interacción `sex*statusquo`, el modelo contiene 2 efectos de `statusquo`.

```{r, echo=F}
median_income = median(datos_chile$income, na.rm = T)
median_sq = median(datos_chile$statusquo, na.rm = T)

beta_sq_F = mymodel$coefficients["statusquo"]
beta_sq_M = mymodel$coefficients["statusquo"] + mymodel$coefficients["sexM:statusquo"]

grid <- datos_chile %>% data_grid(sex,income=median_income, statusquo = median_sq, .model=mymodel)
newx <- grid %>% mutate(logit = predict(mymodel, newdata = grid), p_hat = 1/(1 + exp(-logit))) %>%
  mutate(beta_sq = if_else(sex=="F",beta_sq_F,beta_sq_M)) %>%
  mutate(marginal_effect = beta_sq*p_hat*(1-p_hat))


```
Los efectos marginales correctos son los siguientes:

```{r, echo=F}
print(newx %>% select(sex,income,statusquo,marginal_effect))
```


2. Usa el método de Bootstrap para crear un intervalo de confianza al 92% para la diferencia entre los efectos marginales de hombres y mujeres reportados en la pregunta 1. 

```{r,echo=F}

# Escribir una función que ejecute re-sampling y la estimación
bs_diff  <- function(x) {
  data_b  <- sample_n(datos_chile,size=nrow(datos_chile), replace=TRUE)
  logit_b <- glm(mymodel$formula, family=binomial(link="logit"), data=data_b)
  
  beta_sq_F_b = logit_b$coefficients["statusquo"]
  beta_sq_M_b = logit_b$coefficients["statusquo"] + logit_b$coefficients["sexM:statusquo"]
  
  newx <- grid %>% mutate(logit = predict( logit_b, newdata = grid), p_hat = 1/(1 + exp(-logit))) %>%
    mutate(beta_sq = if_else(sex=="F",beta_sq_F_b,beta_sq_M_b)) %>%
    mutate(marginal_effect = beta_sq*p_hat*(1-p_hat))
    
  diff_b = newx$marginal_effect[1] - newx$marginal_effect[2] 
  
  return(diff_FM_b = diff_b)
}

# Iterar función y almacenar resultados 
nreps = 1000
diffs_bs <- replicate(nreps,bs_diff()) %>% as_tibble()

ci_diffs_bs <- quantile(diffs_bs$value, p=c(0.04,0.96))

```

El intervalo de confianza correcto es el siguiente:

```{r, echo=F}
ci_diffs_bs
```

La "bootstrap distribution" de la diferencia entre los efectos marginales de hombres y mujeres se ve así:

```{r, echo=F}
diffs_bs  %>%  ggplot(aes(x=value)) + geom_density() + labs(x= "Dif. ME apoyo status-quo entre mujer y hombre mediano sobre propabilidad votar NO")
```


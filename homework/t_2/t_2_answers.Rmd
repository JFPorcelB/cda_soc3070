---
title: "SOC3070 Análisis de Datos Categóricos"
author: "Trabajo 2"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r, echo=FALSE,message=FALSE, warnings=FALSE}
# Escribir install.packages("tinytex") en la consola para instalar "tinytex"
# Escribir install.packages("tidyverse") en la consola para instalar "tinytex"
# Escribir install.packages("modelr") en la consola para instalar "tinytex"
library("tinytex")
library("tidyverse")
library("nnet")
library("modelr")
library("MASS")
library("marginaleffects")
```

**Información**

Ponderación: 20% de la nota final del curso.
Entrega: Desde el momento de entrega, los estudiantes tienen 2 semanas exactas de plazo para completar esta tarea. Responder las preguntas _bonus_ NO es un requisito necesario para obtener puntaje completo. Responder incorrectamente las preguntas _bonus_ no afectará negativamente la nota obtenida, pero responderlas correctamente mejorará la nota obtenida en un máximo de 0.7 puntos (o en la cantidad necesaria para obtener nota máxima si la nota original fuera superior a 6.3)

**Introducción**

En esta tarea usarán regresión logística multinomial (MNLR) para re-analizar un subconjunto de los datos utilizados en el artículo _"It’s not just how the game is played, it’s whether you win or lose"_ (2019). Este estudio utiliza un experimento online para identificar el efecto causal de las desigualdades de oportunidades y de resultados sobre creencias acerca de las causas de la desigualdad y percepciones de justicia. 

En particular, deberán estimar los efectos de las dos manipulaciones experimentales del estudio sobre las probabilidades de atribuir los resultados de la competencia al talento ("talent"), la suerte ("luck") o circunstancias externas al individuo  ("rules"). Estas respuestas se encuentan en la variable `LTC`. Una de las manipulaciones experimentales es el status de ganador o perdedor de los participantes (variable `W`, donde W=1 corresponde a los ganadores). La otra es el nivel de desigualdad de oportunidades en la competencia, el cual es determinado por el tratamiento al que cada individuo fue asignado (variable `T`). Para esta tarea usarán el subconjunto de datos correspondientes a los tratamientos RA ("random exchange", es decir, "level of redistribution" = 0), RE1 ("regressive exchange" con "level of redistribution" = 1) y RE2 ("regressive exchange" con "level of redistribution" = 2). 

Para mayor contexto pueden revisar el artículo en el link indicado en el repositorio. Igualmente, los datos están disponibles en el repositorio del curso para ser descargados. 

````{r, message=FALSE, warnings=FALSE}
path <- url("https://raw.githubusercontent.com/mebucca/cda_soc3070/master/homework/t_2/data_t_2.csv")
data_paper <- read_csv(path) %>% mutate(W=if_else(W=="TRUE",1,0))
data_paper %>% glimpse()
````

\pagebreak

**Ejercicios**

1. Usa regresión logística multinomial para estimar modelar las atribuciones de los resultados a las reglas/talento/suerte en función del estatus de ganarador/perdedor y el tratamiento(variables `T` y `W` sin interacción). Presenta un `summary()` de los resultados. Usa `LTC = "rules"` como categoría de referencia en la variable dependiente.

````{r}
data_paper$LTC <- factor(data_paper$LTC, levels = c("rules","talent","luck"))
mnlr_1 <- multinom(LTC ~ W + T, data=data_paper)
summary(mnlr_1)
````

1.1 Interpreta los coeficientes asociados a `W-talent` y  `TRE2-luck`.

El coeficiente asociado a `W-talent` indica que las log-odds de que un ganador atribuya los resultados al talento en vez de a la reglas del juego son 1.14 puntos menores que la de los perdedores. Por su parte, el coeficiente asociado a `TRE2-luck` indica que las log-odds de que un jugador en el tratamiento RE2 atribuya los resultados a la suerte en vez de a la reglas del juego son 1.89 puntos menores que la de los jugadores del tratamiento RA. 


1.2 Transforma e interpreta el coeficiente correspondiente a `W-talent` en términos de odds-ratios (o probabilidades relativas) y presenta el desarrollo formal de dicha odds-ratio.

Transformamos el coeficiente en odds ratios exponenciando el original:
````{r}
exp(summary(mnlr_1)$coefficients)["talent","W"]
````

Formalmente:

$\ln \frac{\mathbb{P}(\text{talent | W=1, T=t)}}{\mathbb{P}(\text{rules | W=1, T=t)}} = \beta_{0-talent} + \beta_{W-talent} + \beta_{T-talent}*t$

y

$\ln \frac{\mathbb{P}(\text{talent | W=0, T=t)}}{\mathbb{P}(\text{rules | W=0, T=t)}} = \beta_{0-talent} +  \beta_{T-talent}*t$

Por tanto:


$\frac{\mathbb{P}(\text{talent | W=1, T=t)}}{\mathbb{P}(\text{rules | W=1, T=t)}} = e^{\beta_{0-talent}} \cdot e^{\beta_{W-talent}} \cdot e^{ \beta_{T-talent}*t}$

y

$\frac{\mathbb{P}(\text{talent | W=0, T=t)}}{\mathbb{P}(\text{rules | W=0, T=t)}} = e^{\beta_{0-talent}}\cdot e^{ \beta_{T-talent}*t}$

se sigue de esto que


$\frac{\mathbb{P}(\text{talent | W=1, T=t)}}{\mathbb{P}(\text{rules | W=1, T=t)}} \bigg/ \frac{\mathbb{P}(\text{talent | W=0, T=t)}}{\mathbb{P}(\text{rules | W=0, T=t)}} = e^{\beta_{0-talent}} \cdot e^{\beta_{W-talent}} \cdot e^{ \beta_{T-talent}*t} / e^{\beta_{0-talent}}\cdot e^{ \beta_{T-talent}*t} = e^{\beta_{W-talent}} =e^{1.1390192} = 3.123703$

es decir, el ratio entre la probabilidad de atribuir los resultados al talento y la probabilidad de atribuirlos a las reglas por parte de los ganadores es más de 3 veces el ratio observado para los perdedores.


1.3. Calcula la odds ratio de atribuir los resultados al talento en vez de a la suerte entre ganadores y perdedores.


$e^{\beta_{W-talent} - \beta_{W-luck}} = e^{(1.1390192 - -0.3791515 )} = 1.518171$


1.4 Manipula los resultados del modelo para obtener las probabilidades esperadas de que los ganadores del tratamiento RA sostengan que los resultados de la competencia se deben principalmente al "talento". Expresa formalmente la ecuación correspondiente a esta predicción.

En términos generales sabemos que:

$p_{ji} =\frac{e^{\beta_{j0} + \beta_{j1}x_{1i} + \dots + \beta_{jk}x_{ki}}}{1 + \sum^{J-1}_{j=1}  e^{\beta_{j0} + \beta_{j1}x_{1i} + \dots + \beta_{jk}x_{ki}}}$


Por tanto:

- $\mathbb{P}(\text{talent | T=RA, W=1}) = \frac{e^{\beta_{0-talent} + \beta_{W-talent}}}{1 + e^{(\beta_{0-talent} + \beta_{W-talent})}  + e^{(\beta_{0-luck} + \beta_{W-luck})} } = e^{0.1622638 + 1.1390192}/(1 + e^{0.1622638 + 1.1390192} + e^{1.7585717 - 0.3791515}) = 0.425$

Implementación en `R`:  
```{r}
newx <- data_paper %>% data_grid(T="RA",W=1,.model=mnlr_1)
newy <- cbind(newx,predict(mnlr_1, newdata = newx, type = "probs"))
print(newy)
```


1.5 Agrega un control por `age` al modelo estimado en 1. Presenta un `summary()` de los resultados.

```{r}
mnlr_2 <- multinom(LTC ~ W + T + age, data=data_paper)
summary(mnlr_2)
```


1.6. (Bonus 1) De acuerdo al modelo estimado en 1.5., ¿cuál es _efecto_ (marginal) de edad sobre la probabilidad de que un ganador de 30 años en el tratamiento RA atribuya los resultados al talento?

Sabemos que:

- $\frac{\partial p_{ij}}{\partial x_{k}} = p_{ij} \cdot \bigg( \beta_{jk} - \sum^{J-1}_{j=1} \beta_{jk}\cdot p_{ij}\bigg)$

y

- $p_{ji} =\frac{e^{\beta_{j0} + \beta_{j1}x_{1i} + \dots + \beta_{jk}x_{ki}}}{1 + \sum^{J-1}_{j=1}  e^{\beta_{j0} + \beta_{j1}x_{1i} + \dots + \beta_{jk}x_{ki}}}$

Por tanto, calculamos las probabilidad en cuestión:

```{r}
newx <- data_paper %>% data_grid(T="RA",W=1, age=30,.model=mnlr_2)
newy <- cbind(newx,predict(mnlr_2, newdata = newx, type = "probs"))
print(newy)
```

Luego, el efecto marginal de edad sobre la probabilidad de 
\begin{align*}
\frac{\partial \mathbb{P}(\text{talent | T=RA, W=1, age=30})}{\partial \text{age}} &=   p_{\text{talent }i} \cdot (\beta_{age-\text{talent}} - (\beta_{age-\text{talent}}*p_{\text{talent }i} + \beta_{age-\text{luck}}*p_{\text{luck }i} )) \\ \\
&= 0.3973563*(0.0135646702  - (0.3973563*0.0135646702 + -0.0004814554*0.4820708) ) \\ \\
&= 0.003340479
\end{align*}

Implementación en `R`:

```{r}
marginaleffects(mnlr_2, variables="age", newdata = newx)
```

Es decir, para un ganador de 30 años en el tratamiento RA un aumento en un año de edad se traduce en un aumento en 0.003340479 puntos porcentuales en la probabilidad de atribuir los resultados al talento.

2. Usando los datos de infidelidad, estima un modelo Poisson para la tasa de infidelidad a lo largo del matrimonio.

```{r,  include=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
library("Ecdat")
data(Fair)
affairsdata <- Fair %>% as_tibble()
```

 
 - La variable `nbaffairs` mide la cantidad de relaciones extra-matrimoniales que ha tenido una persona. La variable `ym` mide los años que una persona ha estado casada.
 
 - Modela la cantidad de relaciones extra-matrimoniales que ha tenido una persona como función de su genero (`age`), su felicidad en el matrimonio (`rate`) y la interacción entre ambas.

```{r,  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
model_inf <- glm(nbaffairs ~  rate*factor(sex), family=poisson(link=log), offset = log(ym), data=affairsdata)
summary(model_inf)
```


10.1 Interpreta el efecto multiplicativo de la variable felicidad en el matrimonio sobre la tasa de infidelidad de los hombres.

Un aumento en una unidad de evaluación de felicidad en el matrimonio disminuye en un 33%  ( $e^{-0.31686-0.08003} - 1$ ) la tasa de infidelidad de los hombres.


10.2 Estima la cantidad esperada de relaciones extra-matrimoniales para una mujer en un matrimonio infeliz (`rate`=2) de 20 años de duración.

$\mu_{i} = \theta_{i}\cdot n_{i}$

$\mu_{i} = e^{(\beta_{0} + 2\beta_{rate})} \cdot ym_{i}$

$\mu_{i} = e^{(-0.63898 + 2 \cdot -0.31686)} \cdot 20 = 5.601488$


Implementación en `R`:
```{r}
predict(model_inf, newdata = data.frame(rate=2, sex="female", ym=20), type="response")
```

 